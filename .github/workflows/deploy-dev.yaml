name: Genesys Cloud Email Dev
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  deploy-email-flow-dev:
    runs-on: ubuntu-latest
    env:
      GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_DEV }}
      GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_DEV }}
      GENESYSCLOUD_API_REGION: "https://api.usw2.pure.cloud"
      GENESYSCLOUD_REGION: "us-west-2"
      GENESYSCLOUD_ARCHY_REGION: "usw2.pure.cloud"
      TF_VAR_genesys_email_domain: "devengagedev"
      TF_VAR_genesys_email_domain_region: "pure.cloud"
      TF_VAR_classifier_url: "https://lw5n6y5cfe.execute-api.us-east-1.amazonaws.com/dev/emailresolver"
      TF_VAR_classifier_api_key: ${{ secrets.GENESYSCLOUD_CLASSIFIER_API_KEY }}

    steps:
      #Checks out the code out of the source control system and begins setup.
      - uses: actions/checkout@v2
      - uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      - name: Checkout code, setup output directory and install the python client
        run: |
          mkdir output
          pip install PureCloudPlatformClientV2

      #Install archy
      - name: Download and install archy
        run: |
          mkdir archy
          cd archy
          wget -q https://sdk-cdn.mypurecloud.com/archy/latest/archy-linux.zip
          unzip archy-linux.zip
          . archy version                              #Need this command because archy replaces the path in the the file the first time it is run
          export PATH=$PATH:$GITHUB_WORKSPACE/archy
          cd ..
          pwd
          archy version

      #Init Terraform and run it
      - name: Initialize terraform and run its
        run: |
          cd dev 
          terraform init 
          terraform apply --auto-approve
          cd ..

      #Run Archy to import a flow
      - name: Run Archy to import flow
        run: |
          export PATH=$PATH:$GITHUB_WORKSPACE/archy
          archy publish --forceUnlock --file=$GITHUB_WORKSPACE/flows/EmailComprehendFlow.yaml --clientId $GENESYSCLOUD_OAUTHCLIENT_ID --clientSecret $GENESYSCLOUD_OAUTHCLIENT_SECRET --location $GENESYSCLOUD_ARCHY_REGION  --overwriteResultsFile --resultsFile $GITHUB_WORKSPACE/output/results.json
          cat $GITHUB_WORKSPACE/output/results.json

      #Use the CLI to create the email domain route
      - name: Add email domain route
        run: |
          export GENESYSCLOUD_FLOW_ID=$(cat $GITHUB_WORKSPACE/output/results.json | jq -r '.output.flowInfo.id')
          python $GITHUB_WORKSPACE/scripts/create_email_domain.py
